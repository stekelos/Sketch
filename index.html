<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Color Diary (Pie Chart)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
            background-color: #f0f0f0;
        }
        .toolbox {
            margin: 20px 0;
        }
        canvas {
            border: 1px solid #ccc;
            background: white;
            margin: 10px auto;
            display: block;
        }
        input, button {
            padding: 8px;
            margin: 5px;
        }
        #periodFilter {
            margin-top: 10px;
        }
        #legend {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h2>Mood Color Diary (Pie Chart)</h2>
    <div class="toolbox">
        <input type="date" id="moodDate">
        <button onclick="addMood()">Προσθήκη Διάθεσης</button>
    </div>
    <div id="periodFilter">
        <label>Φίλτρο Περιόδου: </label>
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button onclick="filterMoods()">Εφαρμογή</button>
    </div>
    <canvas id="moodCanvas" width="400" height="400"></canvas>
    <div id="legend"></div>

    <script>
        const canvas = document.getElementById('moodCanvas');
        const ctx = canvas.getContext('2d');
        const colors = ['#FFFF00', '#FFA500', '#FF0000']; // Κίτρινο, Πορτοκαλί, Κόκκινο

        // Λειτουργίες για χειρισμό cookies
        function setCookie(name, value) {
            document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))}; path=/`; // Χωρίς expires για μονιμότητα
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
            return null;
        }

        // Φόρτωση moods από cookie ή κενή λίστα
        let moods = getCookie('moods') || [];

        // Εμφάνιση πίτας
        function renderPieChart(filteredMoods = moods) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 20;
            const total = filteredMoods.length || 1;
            const sliceAngle = (2 * Math.PI) / total;

            filteredMoods.sort((a, b) => new Date(a.date) - new Date(b.date));

            filteredMoods.forEach((mood, index) => {
                const startAngle = index * sliceAngle;
                const endAngle = startAngle + sliceAngle;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.fillStyle = colors[mood.state % 3];
                ctx.fill();
                ctx.stroke();
            });

            updateLegend(filteredMoods);
            if (filteredMoods.length === 0) {
                ctx.fillStyle = '#000';
                ctx.fillText('Δεν υπάρχουν διαθέσεις για αυτή την περίοδο.', centerX - 100, centerY);
            }
        }

        // Ενημέρωση λεζάντας
        function updateLegend(filteredMoods) {
            const legend = document.getElementById('legend');
            legend.innerHTML = filteredMoods.map(mood => 
                `<span style="color: ${colors[mood.state % 3]}">■</span> ${new Date(mood.date).toLocaleDateString('el-GR')}`
            ).join('<br>');
        }

        // Προσθήκη διάθεσης
        function addMood() {
            const dateInput = document.getElementById('moodDate').value;
            const date = dateInput ? new Date(dateInput).toISOString() : new Date().toISOString();

            const existingMood = moods.find(m => new Date(m.date).toDateString() === new Date(date).toDateString());
            if (existingMood) {
                existingMood.state = (existingMood.state + 1) % 3;
            } else {
                moods.push({ date, state: 0 });
            }

            setCookie('moods', moods); // Αποθήκευση σε cookie
            renderPieChart();
        }

        // Φιλτράρισμα διάθεσης ανά περίοδο
        function filterMoods() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            if (!startDate || !endDate || startDate > endDate) {
                alert('Παρακαλώ διάλεξε έγκυρες ημερομηνίες!');
                return;
            }

            const filteredMoods = moods.filter(mood => {
                const moodDate = new Date(mood.date);
                return moodDate >= startDate && moodDate <= endDate;
            });

            renderPieChart(filteredMoods);
        }

        // Χειρισμός κλικ στον καμβά
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left - canvas.width / 2;
            const y = e.clientY - rect.top - canvas.height / 2;
            const angle = Math.atan2(y, x) < 0 ? Math.atan2(y, x) + 2 * Math.PI : Math.atan2(y, x);
            const total = moods.length || 1;
            const sliceAngle = (2 * Math.PI) / total;
            const clickedSlice = Math.floor(angle / sliceAngle);

            if (clickedSlice < moods.length) {
                moods[clickedSlice].state = (moods[clickedSlice].state + 1) % 3;
                setCookie('moods', moods); // Ενημέρωση cookie
                renderPieChart();
            }
        });

        // Αρχική εμφάνιση
        renderPieChart();

        // Προεπιλογή σημερινής ημερομηνίας
        document.getElementById('moodDate').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>
